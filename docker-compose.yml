services:
  mysql_db:
    container_name: mysql_db
    restart: unless-stopped
    env_file: .env
    image: mysql:8.0.35
    command: --default-authentication-plugin=caching_sha2_password
    environment:
      - MYSQL_ROOT_PASSWORD=$DB_PASS
      - MYSQL_DATABASE=$DB_NAME
    ports:
      - $DB_PORT:3306
    volumes:
      - db_data:/var/lib/mysql
      - ./.env:/.env

  # ==========================================================================
  # LocalStack - Local AWS S3 Emulator
  # ==========================================================================
  # LocalStack provides a local S3 emulator for development.
  # NOTE: LocalStack data does NOT persist between docker compose down/up.
  #
  # When using real AWS S3, images persist normally.
  # Database (users) always persists via the db_data volume.
  #
  # To use real AWS S3 instead:
  # 1. Comment out this service
  # 2. Set S3_ENDPOINT= (empty) in your .env
  # 3. Fill in your real AWS credentials
  # ==========================================================================
  localstack:
    container_name: "s3-bucket-localstack-main"
    image: localstack/localstack:s3-latest
    ports:
      - "127.0.0.1:4566:4566"
    environment:
      - DEBUG=${DEBUG:-0}
    volumes:
      # Mount the init script - runs automatically on container start
      - "./localstack/init-s3.sh:/etc/localstack/init/ready.d/init-s3.sh"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    container_name: backend
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./backend/Dockerfile
    env_file: .env
    environment:
      # Database configuration
      - DB_HOST=mysql_db
      - DB_PORT=3306
      - DB_USER=$DB_USER
      - DB_PASS=$DB_PASS
      - DB_NAME=$DB_NAME
      # S3 configuration (passed from .env)
      # S3_ENDPOINT: Internal endpoint for Docker network (e.g., http://localstack:4566)
      # S3_PUBLIC_ENDPOINT: Public endpoint for browser access (e.g., http://localhost:4566)
      - S3_ENDPOINT=$S3_ENDPOINT
      - S3_PUBLIC_ENDPOINT=$S3_PUBLIC_ENDPOINT
      - AWS_ACCESS_KEY=$AWS_ACCESS_KEY
      - AWS_SECRET_KEY=$AWS_SECRET_KEY
      - AWS_BUCKET_REGION=$AWS_BUCKET_REGION
      - AWS_BUCKET_NAME=$AWS_BUCKET_NAME
    ports:
      - $PORT:3000
    depends_on:
      mysql_db:
        condition: service_started
      localstack:
        condition: service_healthy
    volumes:
      - ./backend:/src

  frontend:
    container_name: frontend
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./frontend/Dockerfile
    ports:
      - 3001:3001
    depends_on:
      - backend
    volumes:
      - ./frontend:/app

volumes:
  db_data:
